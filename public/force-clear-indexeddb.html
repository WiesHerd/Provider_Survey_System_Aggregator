<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Clear IndexedDB - Survey Aggregator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            margin-bottom: 20px;
        }
        .warning {
            background: #fef2f2;
            border: 2px solid #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .warning strong {
            color: #dc2626;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #b91c1c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border: 2px solid #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            color: #1e40af;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Force Clear IndexedDB</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è WARNING:</strong> This will permanently delete ALL survey data from your browser's local storage (IndexedDB). 
            This action cannot be undone. Your Firebase cloud data will NOT be affected.
        </div>

        <p>Use this tool if surveys are stuck and won't delete normally.</p>

        <button id="clearBtn" onclick="clearIndexedDB()">Clear All IndexedDB Data</button>
        <button onclick="checkIndexedDB()">Check What's in IndexedDB</button>
        <button onclick="window.location.href = '/'">Go Back to App</button>

        <div id="status"></div>
    </div>

    <script>
        const DB_NAME = 'SurveyAggregatorDB';
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }

        function checkIndexedDB() {
            showStatus('Checking IndexedDB...', 'info');
            
            const request = indexedDB.open(DB_NAME);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                const stores = Array.from(db.objectStoreNames);
                
                let info = `<strong>IndexedDB Status:</strong><br>`;
                info += `Database: ${DB_NAME}<br>`;
                info += `Object Stores: ${stores.join(', ')}<br><br>`;
                
                // Count surveys
                if (stores.includes('surveys')) {
                    const tx = db.transaction(['surveys'], 'readonly');
                    const store = tx.objectStore('surveys');
                    const countRequest = store.count();
                    
                    countRequest.onsuccess = () => {
                        info += `Surveys: ${countRequest.result}<br>`;
                        
                        // Count survey data
                        if (stores.includes('surveyData')) {
                            const dataTx = db.transaction(['surveyData'], 'readonly');
                            const dataStore = dataTx.objectStore('surveyData');
                            const dataCountRequest = dataStore.count();
                            
                            dataCountRequest.onsuccess = () => {
                                info += `Survey Data Rows: ${dataCountRequest.result}<br>`;
                                showStatus(info, 'info');
                            };
                        } else {
                            showStatus(info, 'info');
                        }
                    };
                } else {
                    showStatus(info, 'info');
                }
            };
            
            request.onerror = () => {
                showStatus('Error checking IndexedDB: ' + request.error, 'error');
            };
        }

        function clearIndexedDB() {
            if (!confirm('Are you ABSOLUTELY SURE you want to delete ALL IndexedDB data? This cannot be undone!')) {
                return;
            }

            const btn = document.getElementById('clearBtn');
            btn.disabled = true;
            btn.textContent = 'Clearing...';

            showStatus('Starting force clear...', 'info');

            // Close any open connections first
            const openRequest = indexedDB.open(DB_NAME);
            openRequest.onsuccess = (event) => {
                const db = event.target.result;
                db.close();
                
                // Delete the database
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                
                deleteRequest.onsuccess = () => {
                    showStatus('‚úÖ IndexedDB cleared successfully! You can now refresh the app.', 'success');
                    btn.textContent = 'Cleared!';
                    
                    // Also clear localStorage app data
                    try {
                        const appKeys = [
                            'customReports',
                            'enhancedCustomReports',
                            'uploadFormDefaults',
                            'upload_checkpoints',
                            'upload_metrics'
                        ];
                        
                        appKeys.forEach(key => {
                            if (localStorage.getItem(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        console.log('Also cleared localStorage app data');
                    } catch (e) {
                        console.warn('Could not clear localStorage:', e);
                    }
                };
                
                deleteRequest.onerror = () => {
                    showStatus('‚ùå Error clearing IndexedDB: ' + deleteRequest.error, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Clear All IndexedDB Data';
                };
                
                deleteRequest.onblocked = () => {
                    showStatus('‚ö†Ô∏è Database deletion blocked. Please close all other tabs with this app open, then try again.', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Clear All IndexedDB Data';
                };
            };
            
            openRequest.onerror = () => {
                // Database might not exist, which is fine
                showStatus('‚úÖ IndexedDB appears to be empty or already cleared.', 'success');
                btn.disabled = false;
                btn.textContent = 'Clear All IndexedDB Data';
            };
        }

        // Auto-check on load
        window.onload = () => {
            checkIndexedDB();
        };
    </script>
</body>
</html>