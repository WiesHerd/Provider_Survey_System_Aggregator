"use strict";(self.webpackChunksurvey_data_processing_system=self.webpackChunksurvey_data_processing_system||[]).push([[90,256],{3090:(e,t,a)=>{a.d(t,{w:()=>o});var i=a(2555),n=a(2629),r=a(6256);class o{constructor(e){this.MAPPINGS_KEY="specialty-mappings",this.storageService=void 0,this.GROUPS_KEY="specialty_groups",this.LEARNED_MAPPINGS_KEY="learned-specialty-mappings",this.specialtyCache=new Map,this.cacheExpiry=new Map,this.CACHE_TTL=3e5,this.SYNONYMS={cardiology:["heart","cardiac","cardiovascular"],orthopedics:["ortho","orthopedic","orthopaedic"],pediatrics:["peds","pediatric","children"],"critical care":["intensivist","critical care medicine","critical care/intensivist","intensive care","critical care medicine","cc medicine","cc/intensivist","icu"],"emergency medicine":["emergency","er","ed"],"internal medicine":["internist","internal med"],obstetrics:["ob/gyn","obgyn","obstetrics and gynecology","obstetrics & gynecology"],anesthesiology:["anesthesia","anesthetist"],"family medicine":["family practice","family physician","family med"],neurology:["neurological","neuro"],psychiatry:["psychiatric","mental health"],radiology:["radiologist","imaging","diagnostic radiology"],surgery:["surgeon","surgical"]},this.storageService=e}async saveMapping(e){const t={standardizedName:e.standardizedName,sourceSpecialties:e.sourceSpecialties.map(e=>({specialty:e.specialty,originalName:e.originalName,surveySource:e.surveySource}))};await fetch("".concat({NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api","/mappings/specialty"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async getAllMappings(){try{const e=await fetch("".concat({NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api","/mappings/specialty"));if(!e.ok)throw new Error("Failed to fetch");return await e.json()}catch(e){return console.error("Error fetching specialty mappings:",e),[]}}async getUnmappedSpecialties(){try{console.log("\ud83d\udd04 Fetching unmapped specialties with caching...");const e=r.default.getInstance();console.log("\ud83d\udce1 Calling backendService.getAllSurveys()...");const t=await e.getAllSurveys();console.log("\ud83d\udcca Surveys received:",t.length,t);const a=await this.getAllMappings();console.log("\ud83d\uddfa\ufe0f Existing mappings:",a.length);const i=[],n=new Set;a.forEach(e=>{n.add(e.standardizedName.toLowerCase()),e.sourceSpecialties.forEach(e=>{n.add(e.specialty.toLowerCase())})}),console.log("\u2705 Mapped names collected:",Array.from(n));const o=10;for(let r=0;r<t.length;r+=o){const a=t.slice(r,r+o);console.log("\ud83d\udce6 Processing batch ".concat(Math.floor(r/o)+1,"/").concat(Math.ceil(t.length/o)));const s=a.map(async t=>{try{console.log("\ud83d\udd0d Fetching data for survey ".concat(t.id,"..."));const{rows:a}=await e.getSurveyData(t.id,{},{page:1,limit:1e4});console.log("\ud83d\udccb Survey ".concat(t.id," returned ").concat(a.length," rows"));const i=new Map;a.forEach((e,t)=>{0===t&&console.log("\ud83d\udccb All column names in row:",Object.keys(e));const a=["specialty","Specialty","Provider Type","provider_type","ProviderType","specialty_name","SpecialtyName","specialtyName","PROVIDER_TYPE","SPECIALTY","Specialty Type","specialty_type"];let n="";for(const i of a)if(e[i]&&"string"===typeof e[i]&&e[i].trim()){n=e[i].trim(),console.log('\u2705 Found specialty in column "'.concat(i,'": ').concat(n));break}if(n){const e=n;i.set(e,(i.get(e)||0)+1)}t<5&&console.log("Row ".concat(t,":"),{specialty:n,row:e})}),console.log("\ud83c\udfe5 Found specialties in survey ".concat(t.id,":"),Array.from(i.entries()));return{surveySource:t.type||t.surveyProvider||"Unknown",counts:i}}catch(a){return console.error("\u274c Error processing survey ".concat(t.id,":"),a),{surveySource:"Unknown",counts:new Map}}});(await Promise.all(s)).forEach(e=>{let{surveySource:t,counts:a}=e;a.forEach((e,a)=>{const r=a.toLowerCase();n.has(r)||i.push({id:"".concat(t,"-").concat(a),name:a,surveySource:t,frequency:e})})})}return console.log("\u2705 Found ".concat(i.length," unmapped specialties:"),i),i}catch(e){return console.error("\u274c Error getting unmapped specialties:",e),[]}}async autoMapSpecialties(e){console.log("\ud83d\ude80 Starting auto-mapping with retry logic...");const t=await this.getUnmappedSpecialties(),a=await this.getAllMappings(),i=[],n=[],r=[];for(let o=0;o<t.length;o+=50)r.push(t.slice(o,o+50));for(let o=0;o<r.length;o++){const t=r[o];console.log("\ud83d\udce6 Processing auto-mapping batch ".concat(o+1,"/").concat(r.length));const s=t.map(async t=>this.processSpecialtyWithRetry(t,a,e,3));(await Promise.allSettled(s)).forEach((e,a)=>{const r=t[a];var o;"fulfilled"===e.status&&e.value?i.push(e.value):n.push({specialty:r.name,error:"rejected"===e.status?(null===(o=e.reason)||void 0===o?void 0:o.message)||"Unknown error":"Failed to process"})})}return console.log("\u2705 Auto-mapping completed: ".concat(i.length," successful, ").concat(n.length," failed")),n.length>0&&console.warn("\u26a0\ufe0f Failed mappings:",n),i}async processSpecialtyWithRetry(e,t,a,i){for(let r=1;r<=i;r++)try{const i=this.findBestMatch(e.name,t,a);if(i&&i.confidence>=a.confidenceThreshold){const a=t.find(e=>e.standardizedName===i.standardizedName);if(a)return a.sourceSpecialties.push({id:crypto.randomUUID(),specialty:e.name,originalName:e.name,surveySource:e.surveySource,mappingId:a.id}),await this.saveMapping(a),a}return null}catch(n){if(console.error("Attempt ".concat(r," failed for specialty ").concat(e.name,":"),n),r===i)throw n;await new Promise(e=>setTimeout(e,1e3*Math.pow(2,r)))}return null}findSuggestedMatches(e,t){return t.map(t=>({standardizedName:t.standardizedName,confidence:this.calculateConfidence(e,t)})).filter(e=>e.confidence>.3).sort((e,t)=>t.confidence-e.confidence).slice(0,5)}findBestMatch(e,t,a){return t.map(t=>({standardizedName:t.standardizedName,confidence:this.calculateConfidence(e,t,a.useFuzzyMatching,!0)})).filter(e=>e.confidence>=a.confidenceThreshold).sort((e,t)=>t.confidence-e.confidence)[0]||null}calculateConfidence(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=0;const o=e.toLowerCase(),s=t.standardizedName.toLowerCase();if(this.getLearnedMapping(e).then(e=>{if(e&&e===t.standardizedName)return 1}),o===s)return 1;if((o.includes("critical care")||o.includes("intensivist")||s.includes("critical care")||s.includes("intensivist"))&&(o.includes("critical care")||o.includes("intensivist"))&&(s.includes("critical care")||s.includes("intensivist")))return.95;if(i)for(const[n,c]of Object.entries(this.SYNONYMS)){const e=o.includes(n)||c.some(e=>o.includes(e)),t=s.includes(n)||c.some(e=>s.includes(e));e&&t&&(r=Math.max(r,.9))}if(a){const e=(0,n.jM)(o,s);r=Math.max(r,e);for(const a of t.sourceSpecialties){const e=a.specialty.toLowerCase();if(o===e)return 1;const t=(0,n.jM)(o,e);r=Math.max(r,t),(o.includes(e)||e.includes(o))&&(r=Math.max(r,.85))}}return r}async saveGroup(e){const t=await this.getAllGroups(),a=t.findIndex(t=>t.id===e.id);if(a>=0)t[a]=(0,i.A)((0,i.A)({},e),{},{updatedAt:new Date});else{const a=new Date;t.push((0,i.A)((0,i.A)({},e),{},{createdAt:a,updatedAt:a}))}await this.storageService.storeSurveyData({id:this.GROUPS_KEY,metadata:{type:"specialty_groups",totalRows:t.length,uniqueSpecialties:[],uniqueProviderTypes:[],uniqueRegions:[],columnMappings:{}},rows:t})}async getAllGroups(){try{return(await this.storageService.getSurveyData(this.GROUPS_KEY)).rows}catch(e){return[]}}async deleteGroup(e){const t=(await this.getAllGroups()).filter(t=>t.id!==e);await this.storageService.storeSurveyData({id:this.GROUPS_KEY,metadata:{type:"specialty_groups",totalRows:t.length,uniqueSpecialties:[],uniqueProviderTypes:[],uniqueRegions:[],columnMappings:{}},rows:t})}async getMappings(){try{return await this.storageService.getItem(this.MAPPINGS_KEY)||[]}catch(e){return console.error("Error fetching specialty mappings:",e),[]}}async createMapping(e,t){const a={id:crypto.randomUUID(),standardizedName:e,sourceSpecialties:t.map(e=>(0,i.A)((0,i.A)({},e),{},{mappingId:crypto.randomUUID()})),createdAt:new Date,updatedAt:new Date};for(const i of t)i.specialty!==e&&await this.saveLearningData(i.specialty,e);return await this.saveMapping(a),a}async updateMapping(e,t){const a=await this.getMappings(),n=a.findIndex(t=>t.id===e);if(-1===n)throw new Error("Mapping with id ".concat(e," not found"));t.standardizedName&&t.standardizedName!==a[n].standardizedName&&await this.saveLearningData(a[n].standardizedName,t.standardizedName);const r=(0,i.A)((0,i.A)((0,i.A)({},a[n]),t),{},{updatedAt:new Date});return await fetch("".concat({NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api","/mappings/specialty/").concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),r}async deleteMapping(e){await fetch("".concat({NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api","/mappings/specialty/").concat(e),{method:"DELETE"})}async clearAllMappings(){await fetch("".concat({NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api","/mappings/specialty"),{method:"DELETE"}),await this.storageService.setItem(this.LEARNED_MAPPINGS_KEY,{})}async suggestMappings(e,t){const a=await this.getMappings(),i=[];for(const n of a){let a=0;const r=this.calculateSimilarity(e.name,n.standardizedName,t);a=Math.max(a,r);for(const i of n.sourceSpecialties){const n=this.calculateSimilarity(e.name,i.specialty,t);a=Math.max(a,n)}a>=t.confidenceThreshold&&i.push({mapping:n,similarity:a})}return i.sort((e,t)=>t.similarity-e.similarity).map(e=>e.mapping)}calculateSimilarity(e,t,a){return(e=e.toLowerCase())===(t=t.toLowerCase())?1:a.useFuzzyMatching?(0,n.jM)(e,t):0}async createGroup(e,t){const a=new Date,i={id:"".concat(e).toLowerCase().replace(/\s+/g,"-"),standardizedName:e,selectedSpecialties:t,createdAt:a,updatedAt:a};return await this.saveGroup(i),i}async generateMappingSuggestions(e){const t=await this.getUnmappedSpecialties(),a=e.useExistingMappings?await this.getAllMappings():[],i=[],r=new Map,o=t=>{let a=t.toLowerCase();return e.useFuzzyMatching?(a=a.replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim(),a):a.trim()},s=(t,a)=>{const i=o(t),r=o(a);return e.useFuzzyMatching?(0,n.jM)(i,r):i===r?1:0};return t.forEach(t=>{let i=!1;if(e.useExistingMappings)for(const n of a){if(s(t.name,n.standardizedName)>=e.confidenceThreshold){const e=n.standardizedName,a=r.get(e)||[];a.push({name:t.name,surveySource:t.surveySource}),r.set(e,a),i=!0;break}}if(!i){let a=!1;Array.from(r.entries()).forEach(i=>{let[n,r]=i;if(!a){s(t.name,n)>=e.confidenceThreshold&&(r.push({name:t.name,surveySource:t.surveySource}),a=!0)}}),a||r.set(t.name,[{name:t.name,surveySource:t.surveySource}])}}),Array.from(r.entries()).forEach(e=>{let[t,a]=e;if(a.length>0){let e=0,n=0;for(let t=0;t<a.length;t++)for(let i=t+1;i<a.length;i++)e+=s(a[t].name,a[i].name),n++;const r=n>0?e/n:1===a.length?1:0;i.push({standardizedName:t,confidence:r,specialties:a})}}),i.sort((e,t)=>t.confidence-e.confidence)}async saveLearningData(e,t){try{const a=await this.storageService.getItem(this.LEARNED_MAPPINGS_KEY)||{};a[e.toLowerCase()]=t,await this.storageService.setItem(this.LEARNED_MAPPINGS_KEY,a)}catch(a){console.error("Error saving learning data:",a)}}async getLearnedMapping(e){try{return(await this.storageService.getItem(this.LEARNED_MAPPINGS_KEY)||{})[e.toLowerCase()]||null}catch(t){return console.error("Error getting learned mapping:",t),null}}async getLearnedMappings(){try{return await this.storageService.getItem(this.LEARNED_MAPPINGS_KEY)||{}}catch(e){return console.error("Error getting learned mappings:",e),{}}}async removeLearnedMapping(e){try{const t=await this.getLearnedMappings();delete t[e.toLowerCase()],await this.storageService.setItem(this.LEARNED_MAPPINGS_KEY,t)}catch(t){console.error("Error removing learned mapping:",t)}}}},6256:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});var i=a(2555);const n={NODE_ENV:"production",PUBLIC_URL:"/Provider_Survey_System_Aggregator",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||"http://localhost:3001/api";class r{constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}async getSurveyMeta(e){const t=await fetch("".concat(n,"/survey/").concat(e,"/meta"));if(!t.ok)throw new Error("Failed to fetch survey metadata");return await t.json()}async uploadSurvey(e,t,a,i,r){const o=new FormData;o.append("file",e),o.append("name",t),o.append("year",a.toString()),o.append("type",i);const s=new XMLHttpRequest;return new Promise((e,t)=>{s.open("POST","".concat(n,"/upload")),s.onload=()=>{if(s.status>=200&&s.status<300)try{const t=JSON.parse(s.responseText);e({surveyId:t.surveyId,rowCount:t.rowCount})}catch(a){t(new Error("Invalid server response"))}else t(new Error("Upload failed: ".concat(s.status," ").concat(s.statusText)))},s.onerror=()=>t(new Error("Network error during upload")),s.upload.onprogress=e=>{if(!r||!e.lengthComputable)return;const t=Math.round(e.loaded/e.total*100);r(t)},s.send(o)})}async getAllSurveys(){const e=await fetch("".concat(n,"/surveys"));if(!e.ok)throw new Error("Failed to fetch surveys");return(await e.json()).map(e=>{var t,a,i,n,r,o;return{id:e.id,name:e.name,year:e.year.toString(),type:e.type,uploadDate:e.uploadDate,rowCount:null!==(t=null!==(a=e.rowCount)&&void 0!==a?a:e.row_count)&&void 0!==t?t:0,specialtyCount:null!==(i=null!==(n=e.specialtyCount)&&void 0!==n?n:e.specialty_count)&&void 0!==i?i:0,dataPoints:null!==(r=null!==(o=e.dataPoints)&&void 0!==o?o:e.data_points)&&void 0!==r?r:0,colorAccent:e.colorAccent||"#6366F1",metadata:e.metadata}})}async getSurveyData(e,t,a){const r=new URLSearchParams;null!==t&&void 0!==t&&t.specialty&&r.append("specialty",t.specialty),null!==t&&void 0!==t&&t.providerType&&r.append("providerType",t.providerType),null!==t&&void 0!==t&&t.region&&r.append("region",t.region),null!==a&&void 0!==a&&a.page&&r.append("page",String(a.page)),null!==a&&void 0!==a&&a.limit&&r.append("limit",String(a.limit));const o=await fetch("".concat(n,"/survey/").concat(e,"/data?").concat(r.toString()));if(!o.ok)throw new Error("Failed to fetch survey data");const s=await o.json(),c=(s.data||s).map(e=>(0,i.A)({},e));return{rows:c,pagination:s.pagination?{page:Number(s.pagination.page)||1,limit:Number(s.pagination.limit)||c.length,total:Number(s.pagination.total)||c.length,pages:Number(s.pagination.pages)||1}:void 0}}async getAvailableFiltersForSurvey(e){const t=await fetch("".concat(n,"/survey/").concat(e,"/filters"));if(!t.ok)throw new Error("Failed to fetch filters");return await t.json()}async deleteSurvey(e){if(!(await fetch("".concat(n,"/survey/").concat(e),{method:"DELETE"})).ok)throw new Error("Failed to delete survey")}async deleteAllSurveys(){if(!(await fetch("".concat(n,"/surveys"),{method:"DELETE"})).ok)throw new Error("Failed to delete all surveys")}async exportSurveyData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"csv";const a=await fetch("".concat(n,"/survey/").concat(e,"/export?format=").concat(t));if(!a.ok)throw new Error("Failed to export survey data");return await a.blob()}async healthCheck(){try{return(await fetch("".concat(n,"/health"))).ok}catch(e){return!1}}}r.instance=void 0;const o=r}}]);
//# sourceMappingURL=90.54a2128d.chunk.js.map